<!DOCTYPE html><html lang=en><head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>tinygrad dev exploration</title>
<link rel="stylesheet" href="../main.css">
<link rel="shortcut icon" href="../favicon.ico"></head><body><main><nav><a href='../index.html'>Entrance</a></nav><article><p class="post-date">Created <time datetime="2024-06-22T11:27:48+02:00">2024 06 22</time>, last changed <time datetime="2024-08-11T09:14:30.433374+00:00">2024 08 11</time></p>
<p>tinygrad tries to be simple. I like deleting things. See if I can't help delete in tinygrad. Seems to be a new and adventurous world on the other side.</p>
<h1 id="tinygrad%20dev%20exploration">tinygrad dev exploration</h1>
<div class="toc">
<ul>
<li><a href="#tinygrad%20dev%20exploration">tinygrad dev exploration</a><ul>
<li><a href="#Direction">Direction</a></li>
<li><a href="#More%20refined">More refined</a><ul>
<li><a href="#tinycorp%20mission">tinycorp mission</a></li>
</ul>
</li>
<li><a href="#Less%20refined">Less refined</a><ul>
<li><a href="#encountered%20python">encountered python</a></li>
<li><a href="#Notes%20on%20introduction%20of%20tensor.tolist%28%29%20on%20CLANG">Notes on introduction of tensor.tolist() on CLANG</a><ul>
<li><a href="#Realize">Realize</a><ul>
<li><a href="#Schedule">Schedule</a></li>
<li><a href="#lower%20schedule">lower schedule</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Detected%20room%20for%20improvement%20/%20questions">Detected room for improvement / questions</a></li>
<li><a href="#Research">Research</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h2 id="Direction">Direction</h2>
<p>read</p>
<ul>
<li>tensor.tolist() CLANG introduced</li>
<li>tensor.tolist() CUDA introduced</li>
<li>gpt2 CUDA introduced</li>
</ul>
<p>consider more abstract layers all the way to the mission., connect to code</p>
<h2 id="More%20refined">More refined</h2>
<h3 id="tinycorp%20mission">tinycorp mission</h3>
<p>accelerate, commoditize the petaflop<br />
improve soft-hardware interface for tensor compute first<br />
funded by love and tinyboxes</p>
<p>factory -&gt; soft (tinygrad), hard (tinybox, tinychip?)<br />
product -&gt; compiled models?</p>
<p><em>tinygrad model --&gt; friendly C --&gt; standalone would be (is?) nice</em></p>
<h2 id="Less%20refined">Less refined</h2>
<h3 id="encountered%20python">encountered python</h3>
<p><code>__slots__</code> lists the expected class attributes for fast access and memory savings <a href="https://stackoverflow.com/questions/472000/usage-of-slots">more</a><br />
<code>all()</code> and <code>any()</code> for evaluating multiple bools.<br />
<code>WeakValueDictionary</code> for accessing values that can be garbage collected like the reference isn't there<br />
if there is an argument in a function definition like <code>*atuple</code>,  it becomes optional and returns an empty tuple (or list?) if not given<br />
<code>deque</code> from <code>collections</code> = data structure for efficient insertion and deletion from two ends of a list.<br />
<code>dict.get(self, key, default=None, /)</code> Return the value for key if key is in the dictionary, else default.<br />
format specifiers. <code>int:8</code> means the int takes up 8 spaces when printing. same as <code>int:8d</code> d for digit. can do alignment with <code>int:&gt;8d</code> for right alignment.</p>
<h3 id="Notes%20on%20introduction%20of%20tensor.tolist%28%29%20on%20CLANG">Notes on introduction of tensor.tolist() on CLANG</h3>
<p>TODO: WINO context var to enable winograd optimization?<br />
<code>BinaryOps</code>:</p>
<ul>
<li><code>IDIV</code> = integer division</li>
<li><code>CMPLT</code> = &lt;</li>
<li><code>SHL</code> = shift left</li>
<li><code>THREEFRY</code> = rng related</li>
</ul>
<p><code>TernaryOps</code>:</p>
<ul>
<li><code>WHERE</code> = Multiplexer</li>
<li><code>MULACC</code>: `x*y+z</li>
</ul>
<p><code>ReduceOps</code>:</p>
<ul>
<li><code>WMMA</code> = wave matrix multiply accumulate: hardware accelerated matrix multiplication</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">UOps</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
  <span class="n">SINK</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">EXPAND</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">CONTRACT</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702                                                                                                                                         # codegen/uops.py:15</span>
  <span class="n">DEFINE_GLOBAL</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">DEFINE_VAR</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">DEFINE_LOCAL</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">DEFINE_ACC</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702                                                                                                   # codegen/uops.py:16</span>
  <span class="n">CONST</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">SPECIAL</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702                                                                                                                                                          # codegen/uops.py:17</span>
  <span class="n">NOOP</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">GEP</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702                                                                                                                                                               # codegen/uops.py:18</span>
  <span class="n">CAST</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">BITCAST</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">VECTORIZE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702                                                                                                                                       # codegen/uops.py:20</span>
  <span class="n">ALU</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">REDUCE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">WMMA</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702                                                                                                                                              # codegen/uops.py:21</span>
  <span class="n">LOAD</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">STORE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">PHI</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702                                                                                                                                               # codegen/uops.py:23</span>
  <span class="n">BARRIER</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">IF</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">RANGE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702                                                                                                                                             # codegen/uops.py:25</span>
  <span class="n">ENDRANGE</span> <span class="o">=</span> <span class="n">auto</span><span class="p">();</span> <span class="n">ENDIF</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span> <span class="c1"># noqa: E702 </span>
</code></pre></div>

<p><code>PatternMatcher</code>?</p>
<div class="codehilite"><pre><span></span><code><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;CLANG&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>data -&gt; numpy ndarray</li>
<li>LazyBuffer with shapetracker from ndarray.shape<ul>
<li>lazycache disabled, but <code>LAZYCACHE</code> context variable is 1 by default</li>
<li><code>_METADATA.get()</code> is <code>None</code> by default</li>
<li><code>LazyBuffer</code> gets a <code>Buffer</code> that does not allocate anything yet.</li>
<li>gets allocator from <code>Device</code>, gets <code>NpyDevice</code> from  <code>ops_npy.py</code>, which is unnecessary</li>
<li>puts the ndarray into <code>Buffer._buf</code>, deletes <code>LazyBuffer.srcs</code> (was empty tuple), so that <code>LazyBuffer.realized</code> returns <code>True</code></li>
</ul>
</li>
<li>new <code>LazyBuffer</code> now on <code>CLANG</code>, same shapetracker, <code>MetaOps.COPY</code>, <code>arg</code> = <code>Buffer.size</code>, <code>srcs</code> = tuple with previous (npy) lazybuffer</li>
</ul>
<p>before addition:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Tensor</span><span class="o">.</span><span class="n">lazydata</span> <span class="p">{</span>
    <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;CLANG&#39;</span><span class="p">,</span>
    <span class="s1">&#39;st&#39;</span><span class="p">:</span> <span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">),)),</span>
    <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span>
    <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;_base&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">COPY</span><span class="p">:</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s1">&#39;arg&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="s1">&#39;srcs&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">LB</span> <span class="n">NPY</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">:</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">True</span> <span class="n">device</span><span class="p">:</span><span class="n">NPY</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,),</span>
    <span class="s1">&#39;buffer&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">False</span> <span class="n">device</span><span class="p">:</span><span class="n">CUDA</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s1">&#39;contiguous_child&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;forced_realize&#39;</span><span class="p">:</span> <span class="kc">False</span>
<span class="p">}</span>
</code></pre></div>

<p>addition calls <code>_metadata_wrapper</code>, sets <code>_METADATA</code> to <code>__add__</code>, the function being called.<br />
to add, 2 turns into a Tensor where the lazydata has <code>op=MetaOps.CONST, shape=(), arg=2</code><br />
to add, shapes must match, the "2 Tensor" is broadcasted from shape <code>()</code> to <code>(3,)</code><br />
<code>()</code>-&gt; reshape -&gt; <code>(1,)</code> -&gt; expand -&gt; <code>(3,)</code></p>
<p>by default <code>MERGE_VIEW=1</code>, so the latest <code>View</code> in the <code>ShapeTracker</code> is replaced by the new one.<br />
new <code>LazyBuffer</code> with <code>base</code> being the previous <code>LazyBuffer</code><br />
<code>expand</code> always replaces latest view in shapetracker regardless of <code>MERGE_ViEW</code><br />
again new <code>LazyBuffer</code> with the base of the previous one. The "intermediate" lazybuffer from reshape is garbage collected.</p>
<p>Tensor(2) after broadcasting:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Tensor</span><span class="o">.</span><span class="n">lazydata</span> <span class="p">{</span>
    <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;CLANG&#39;</span><span class="p">,</span>
    <span class="s1">&#39;st&#39;</span><span class="p">:</span> <span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">),)),</span>
    <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span>
    <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">expand</span><span class="p">,</span>
    <span class="s1">&#39;_base&#39;</span><span class="p">:</span> <span class="n">LazyBuffer</span> <span class="p">{</span>
        <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;CLANG&#39;</span><span class="p">,</span>
        <span class="s1">&#39;st&#39;</span><span class="p">:</span> <span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">),)),</span>
        <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span>
        <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(),</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;_base&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">CONST</span><span class="p">:</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="s1">&#39;arg&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;srcs&#39;</span><span class="p">:</span> <span class="p">(),</span>
        <span class="s1">&#39;buffer&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">False</span> <span class="n">device</span><span class="p">:</span><span class="n">CLANG</span> <span class="n">size</span><span class="p">:</span><span class="mi">1</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="s1">&#39;contiguous_child&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;forced_realize&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>addition creates new LazyBuffer;</p>
<div class="codehilite"><pre><span></span><code><span class="n">Tensor</span><span class="o">.</span><span class="n">lazydata</span> <span class="p">{</span>
    <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;CLANG&#39;</span><span class="p">,</span>
    <span class="s1">&#39;st&#39;</span><span class="p">:</span> <span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">),)),</span>
    <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span>
    <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="fm">__add__</span><span class="p">,</span>
    <span class="s1">&#39;_base&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BinaryOps</span><span class="o">.</span><span class="n">ADD</span><span class="p">:</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s1">&#39;arg&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;srcs&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="o">&lt;</span><span class="n">LB</span> <span class="n">CLANG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">COPY</span><span class="p">:</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="o">&lt;</span><span class="n">LB</span> <span class="n">CLANG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">),))</span><span class="o">&gt;</span>
    <span class="p">),</span>
    <span class="s1">&#39;buffer&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">False</span> <span class="n">device</span><span class="p">:</span><span class="n">CLANG</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s1">&#39;contiguous_child&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;forced_realize&#39;</span><span class="p">:</span> <span class="kc">False</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p>The <code>LazyBuffer</code> graph specifies the compute in terms of low level tinygrad ops. Not all LazyBuffers will actually become realized. There's two types of LazyBuffers, base and view. base contains compute into a contiguous buffer, and view is a view (specified by a ShapeTracker). Inputs to a base can be either base or view, inputs to a view can only be a single base.<br />
- <a href="https://docs.tinygrad.org/developer/developer/#tinygrad.lazy.LazyBuffer">tinygrad docs</a></p>
</blockquote>
<h4 id="Realize">Realize</h4>
<div class="codehilite"><pre><span></span><code><span class="n">a</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div>

<p>-&gt; <code>cpu = self.cast(self.dtype.scalar()).contiguous().to("CLANG").realize()</code><br />
cast does nothing because its already the right dtype<br />
contiguous does nothing because its already contiguous<br />
to does nothing, its already on CLANG. Note: this initially looks like it would realize on CLANG regardless of device but really, it just adds a CLANG lazybuffer to the end of the graph, to move the data to the cpu</p>
<h5 id="Schedule">Schedule</h5>
<blockquote>
<p>The scheduler converts the graph of LazyBuffers into a list of ScheduleItem. One ScheduleItem is one kernel on the GPU, and the scheduler is responsible for breaking the large compute graph into subgraphs that can fit in a kernel. ast specifies what compute to run, and bufs specifies what buffers to run it on.<br />
- <a href="https://docs.tinygrad.org/developer/developer/#scheduling">tinygrad docs</a></p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ScheduleItem</span><span class="p">:</span>
  <span class="n">ast</span><span class="p">:</span> <span class="n">LazyOp</span>
  <span class="n">bufs</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Buffer</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
  <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Metadata</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<p><code>children:Dict[LazyBuffer:Dict[Lazybuffer : None]]</code> is in direction of execution, so a child is an lb that depends on the current one. stores only if the parent is unrealized<br />
<code>realizes:Dict[LazyBuffer : None]</code> stores unrealized bases and ones with <code>MetaOps</code>, so it includes the realized npy lb.<br />
<code>output_groups</code> stores lb that are unrealized and not <code>MetaOps.CONST</code><br />
lots of complexity is skipped because there are no ReduceOps in the lb graph.</p>
<p>lop recursively gets a graph of LazyOp from the LazyBuffer graph.<br />
MetaOps.CONST - lbs turn into a LazyOp with BufferOps.CONST, no sources and a ConstBuffer<br />
The realized npy lb turns into a LazyOps with BufferOps.LOAD, no sources and a MemBuffer. adds the buffer to inputs, like other lbs would that are either realized or in realizes but not in the current output_group<br />
ast gets a LazyOp with BufferOps.STORE, lops as sources and a MemBuffer</p>
<p><code>_lower_lazybuffer</code> returns</p>
<ul>
<li><code>LazyOp(MetaOps.KERNEL, tuple(ast))</code></li>
<li><code>list(input)</code></li>
<li>var_vals</li>
<li>some metadata</li>
</ul>
<p>the next group, the lb with MetaOps.COPY returns different: returns a LazyOp with MetaOps.COPY and same sources and arg from the lb.</p>
<div class="codehilite"><pre><span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">prescheduled:Dict[</span>
<span class="sd">    &quot;group[0]&quot;:LazyBuffer : Tuple[</span>
<span class="sd">        &quot;group&quot;: List[LazyBuffer]</span>
<span class="sd">        LazyOp,</span>
<span class="sd">        &quot;inputs&quot;: List[LazyBuffer],</span>
<span class="sd">        &quot;var_vals&quot;: Dict[],</span>
<span class="sd">        &quot;metadata&quot;: List[]</span>
<span class="sd">    ]</span>
<span class="sd">]</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">prescheduled</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="n">LB</span> <span class="n">CLANG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">BinaryOps</span><span class="o">.</span><span class="n">ADD</span><span class="p">:</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">[</span><span class="o">&lt;</span><span class="n">LB</span> <span class="n">CLANG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">COPY</span><span class="p">:</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span><span class="p">],</span>
        <span class="n">LazyOp</span><span class="p">(</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">KERNEL</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="p">(</span>
            <span class="n">LazyOp</span><span class="p">(</span><span class="n">BufferOps</span><span class="o">.</span><span class="n">STORE</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">MemBuffer</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">),))),</span> <span class="n">src</span><span class="o">=</span><span class="p">(</span>
                <span class="n">LazyOp</span><span class="p">(</span><span class="n">BinaryOps</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">LazyOp</span><span class="p">(</span><span class="n">BufferOps</span><span class="o">.</span><span class="n">LOAD</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">MemBuffer</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">),))),</span> <span class="n">src</span><span class="o">=</span><span class="p">()),</span>
                    <span class="n">LazyOp</span><span class="p">(</span><span class="n">BufferOps</span><span class="o">.</span><span class="n">CONST</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">ConstBuffer</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">),))),</span> <span class="n">src</span><span class="o">=</span><span class="p">()),</span>
                <span class="p">)),</span>
            <span class="p">)),</span>
        <span class="p">)),</span>
        <span class="p">[</span><span class="o">&lt;</span><span class="n">LB</span> <span class="n">CLANG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">COPY</span><span class="p">:</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span><span class="p">],</span>
        <span class="p">{},</span>
        <span class="p">[</span><span class="fm">__add__</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="o">&lt;</span><span class="n">LB</span> <span class="n">CLANG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">COPY</span><span class="p">:</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">[</span><span class="o">&lt;</span><span class="n">LB</span> <span class="n">CLANG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">COPY</span><span class="p">:</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">&gt;</span><span class="p">],</span>
        <span class="n">LazyOp</span><span class="p">(</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">COPY</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="p">()),</span>
        <span class="p">[</span><span class="o">&lt;</span><span class="n">LB</span> <span class="n">NPY</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="nb">int</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">EMPTY</span><span class="p">:</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">True</span> <span class="n">device</span><span class="p">:</span><span class="n">NPY</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">],</span>
        <span class="p">{},</span>
        <span class="p">[]</span>
    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>... skipping some ...</p>
<div class="codehilite"><pre><span></span><code><span class="n">schedule</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ScheduleItem</span><span class="p">(</span>
        <span class="n">ast</span><span class="o">=</span><span class="n">LazyOp</span><span class="p">(</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">COPY</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="p">()),</span>
        <span class="n">bufs</span><span class="o">=</span><span class="p">(</span>
            <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">False</span> <span class="n">device</span><span class="p">:</span><span class="n">CLANG</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">True</span> <span class="n">device</span><span class="p">:</span><span class="n">NPY</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span>
        <span class="p">),</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">[]</span>
    <span class="p">),</span>
    <span class="n">ScheduleItem</span><span class="p">(</span>
        <span class="n">ast</span><span class="o">=</span><span class="n">LazyOp</span><span class="p">(</span><span class="n">MetaOps</span><span class="o">.</span><span class="n">KERNEL</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="p">(</span>
            <span class="n">LazyOp</span><span class="p">(</span><span class="n">BufferOps</span><span class="o">.</span><span class="n">STORE</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">MemBuffer</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">),))),</span> <span class="n">src</span><span class="o">=</span><span class="p">(</span>
                <span class="n">LazyOp</span><span class="p">(</span><span class="n">BinaryOps</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">LazyOp</span><span class="p">(</span><span class="n">BufferOps</span><span class="o">.</span><span class="n">LOAD</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">MemBuffer</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">True</span><span class="p">),))),</span> <span class="n">src</span><span class="o">=</span><span class="p">()),</span>
                    <span class="n">LazyOp</span><span class="p">(</span><span class="n">BufferOps</span><span class="o">.</span><span class="n">CONST</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="n">ConstBuffer</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span><span class="p">,</span> <span class="n">st</span><span class="o">=</span><span class="n">ShapeTracker</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">(</span><span class="n">View</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">),))),</span> <span class="n">src</span><span class="o">=</span><span class="p">()),</span>
                <span class="p">)),</span>
            <span class="p">)),</span>
        <span class="p">)),</span>
        <span class="n">bufs</span><span class="o">=</span><span class="p">(</span>
            <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">False</span> <span class="n">device</span><span class="p">:</span><span class="n">CLANG</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">False</span> <span class="n">device</span><span class="p">:</span><span class="n">CLANG</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span>
        <span class="p">),</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">[</span><span class="fm">__add__</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">]</span>
</code></pre></div>

<p>with <code>GRAPH=1</code>, tinygrad produces an svg that reflects this schedule:<br />
<img alt="200" src="attachments/net_1.svg" /></p>
<p><code>_internal_memory_planner</code> does nothing here</p>
<h5 id="lower%20schedule">lower schedule</h5>
<p>in <code>lower_schedule_item</code>, trying to get "transfer" attribute from the allocator, ops_clang are imported</p>
<p>first ExecItem: </p>
<div class="codehilite"><pre><span></span><code><span class="n">ExecItem</span> <span class="p">{</span>
    <span class="n">prg</span><span class="o">=</span><span class="n">tinygrad</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">realize</span><span class="o">.</span><span class="n">BufferCopy</span> <span class="p">{</span>
        <span class="n">device</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">tinygrad</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">ops_clang</span><span class="o">.</span><span class="n">ClangDevice</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7147ec6d3be0</span><span class="o">&gt;</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[33mcopy       12,   CLANG &lt;- NPY    </span><span class="se">\x1b</span><span class="s1">[0m&#39;</span><span class="p">,</span>
        <span class="n">dname</span> <span class="o">=</span> <span class="s2">&quot;CLANG&quot;</span><span class="p">,</span>
        <span class="n">first_run</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">lds_estimate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">mem_estimate</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">op_estimate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="n">bufs</span><span class="o">=</span><span class="p">[</span>
        <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">False</span> <span class="n">device</span><span class="p">:</span><span class="n">CLANG</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="o">&lt;</span><span class="n">buf</span> <span class="n">real</span><span class="p">:</span><span class="kc">True</span> <span class="n">device</span><span class="p">:</span><span class="n">NPY</span> <span class="n">size</span><span class="p">:</span><span class="mi">3</span> <span class="n">dtype</span><span class="p">:</span><span class="n">dtypes</span><span class="o">.</span><span class="n">int</span> <span class="n">offset</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span>
    <span class="p">],</span>
    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span>
<span class="p">}</span>
</code></pre></div>

<p><code>_MallocAllocator</code> always allocates with <code>ctypes.c_uint8 * size</code></p>
<p>if DEBUG &gt;= 2, it will print the kernel (prg) name and kernel number</p>
<ul>
<li>in magenta if jit</li>
<li>in green if the kernel is run the first time</li>
</ul>
<p>"methods" (MetaOps.KERNEL) are cached in the method_cache if they repeat in the schedule</p>
<hr />
<h3 id="Detected%20room%20for%20improvement%20/%20questions">Detected room for improvement / questions</h3>
<p><code>Tensor(2).lazydata.contiguous_child</code> is <code>None</code> but<br />
<code>Tensor(1).lazydata.contiguous_child</code> is a tuple of weakref to some lazybuffer and its own ShapeTracker?</p>
<p>beautiful lazy graph and linearized graph in DEBUG=4</p>
<p>context vars don't add themselves to actual context<br />
some context vars are acceseed via import from helpers, some through getenv<br />
try <code>from tinygrad.helpers import JIT; bool(JIT)</code> -&gt; True<br />
and <code>from tinygrad.helpers import getenv; bool(getenv("JIT"))</code> -&gt; False</p>
<h3 id="Research">Research</h3>
<p>https://towardsdatascience.com/matrix-multiplication-on-the-gpu-e920e50207a8</p>
<p></p>
</article></main></body></html>